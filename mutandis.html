<html>
  <body id=observe-scope>
  <script>
    var modify_url = function(url) {
      /* if webpage http://foo.com/en/bar:
         baz -> foo.com/en/baz
         /baz -> foo.com/baz
         http://wub.org/wug -> wub.org/wug
         /a?b=c&d=e -> foo.com/a_b=c_d=e
         /%21 -> foo.com/%21 (but needs to be foo.com/! in zip file)
         /q#n -> foo.com/q#n (but needs to be foo.com/q in zip file)
         POST requests aren't compatible. :( */ 
      full_original_url = new URL(url, window.location.href).toString() // still contains https://
      zip_url = full_original_url.replace(/(^\w+:|^)\/\//, ''); // remove https://
      return zip_url.replace(/[?&]/g, '_'); // replace query params with underscores 
    }

    console.log(modify_url("baz"));
    console.log(modify_url("/baz"));
    console.log(modify_url("http://wub.org/wug"));
    console.log(modify_url("a?b=c&d=e"));
    console.log(modify_url("/%21"));
    console.log(modify_url("/q#n"));
  </script>
  <script>
    var ELEMENT_NODE = 1;
    var MAX_ATTR = 99;
    var attribute_count = 0;
    // Select the node that will be observed for mutations
    var targetNode = document.getElementById('observe-scope');

    // Options for the observer (which mutations to observe)
    var config = { attributes: true, childList: true, subtree: true, attributeFilter:["src"] };

    // Callback function to execute when mutations are observed
    var callback = function(mutationsList) {
        for(var mutation of mutationsList) {
            // childList: nodes probably added
            if (mutation.type == 'childList') { 
                for(var child of mutation.addedNodes) {
                  if (child.nodeType === ELEMENT_NODE && child.hasAttribute("src")) {
                    var new_url = child.src + "/mutC";
                    var mutandis_src = document.createAttribute("mutandis_src");
                    mutandis_src.value=new_url;
                    child.setAttributeNode(mutandis_src);
                    child.setAttribute("src", new_url);
                  }
                }
            }
            // attributes: attributes modified -- only src due to attributeFilter above
            else if (mutation.type == 'attributes') {
              attribute_count = attribute_count + 1;
              var old_mutandis_src = mutation.target.getAttribute("mutandis_src");
              var old_src = mutation.target.getAttribute("src");
              // only modify changes that we didn't create, and don't change too many!
              if (old_src !== old_mutandis_src && MAX_ATTR > attribute_count) {
                  var new_url = old_src + "/mut"+attribute_count;
                  var mutandis_src = document.createAttribute("mutandis_src");
                  mutandis_src.value = new_url;
                  mutation.target.setAttributeNode(mutandis_src);
                  mutation.target.setAttribute("src", new_url);
              }
            }
        }
    };

    // Create an observer instance linked to the callback function
    var observer = new MutationObserver(callback);

    // Start observing the target node for configured mutations
    observer.observe(targetNode, config);

    //// Later, you can stop observing
    // observer.disconnect();
  </script>

    <img src="fake.jpg" id="target">

  <script>
    document.getElementById("target").src="done.jpg"
  </script>
  </body>
</html>

